import express from "express";
import dotenv from "dotenv";
import connectTODatabae from "./Db/db.js";
import authRouter from "./Route/AuthUser.js";
import messageRouter from "./Route/messageroute.js";
import userRoute from "./Route/userRoute.js";
import cookieParser from "cookie-parser";
import cors from "cors";
import { app, server } from "./Soket/Soket.js";

dotenv.config();

const PORT = process.env.PORT || 3000;

// ================= MIDDLEWARES =================

app.use(express.json());

app.use(
  cors({
    origin: "https://convo-wheat.vercel.app",
    credentials: true,
  })
);

app.use(cookieParser());

// ================= ROUTES =================
app.use("/api/auth", authRouter);
app.use("/api/message", messageRouter);
app.use("/api/user", userRoute);

// ================= HEALTH CHECK =================
app.get("/", (req, res) => {
  res.status(200).send("Chat App Backend Running ðŸš€");
});

// ================= START SERVER =================
const startServer = async () => {
  try {
    await connectTODatabae();
    console.log("âœ… Database connected");

    if (process.env.NODE_ENV !== "production") {
      server.listen(PORT, () => {
        console.log(`ðŸš€ Server running on port ${PORT}`);
      });
    }
  } catch (error) {
    console.error("âŒ Database connection failed:", error.message);
    process.exit(1);
  }
};

startServer();





import { Server } from "socket.io";
import http from "http";
import express from "express";

const app = express();
const server = http.createServer(app);

const io = new Server(server, {
  cors: {
    origin: "https://convo-wheat.vercel.app",
    credentials: true,
  },
});

// userId => Set of socketIds
const userSocketmap = {};

export const getReceiverSocketIds = (receiverId) => {
  return userSocketmap[receiverId] ? Array.from(userSocketmap[receiverId]) : [];
};

io.on("connection", (socket) => {
  const userId = socket.handshake.query.userId;

  if (userId && userId !== "undefined") {
    socket.userId = userId;

    if (!userSocketmap[userId]) {
      userSocketmap[userId] = new Set();
    }

    userSocketmap[userId].add(socket.id);
  }

  io.emit("getOnlineUsers", Object.keys(userSocketmap));

  socket.on("disconnect", () => {
    if (socket.userId) {
      userSocketmap[socket.userId]?.delete(socket.id);

      if (userSocketmap[socket.userId]?.size === 0) {
        delete userSocketmap[socket.userId];
      }
    }

    io.emit("getOnlineUsers", Object.keys(userSocketmap));
  });
});

export { app, io, server };
